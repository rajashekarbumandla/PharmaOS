<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add New Batch | PharmacyOS</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“¦</text></svg>">
    <style>
        :root {
            --primary: #2A6EBB;
            --primary-dark: #1A4F8B;
            --secondary: #00C897;
            --accent: #FF6B6B;
            --warning: #FFA41B;
            --success: #4CAF50;
            --bg-primary: #FFFFFF;
            --bg-secondary: #F8FAFF;
            --bg-tertiary: #EFF3FF;
            --text-primary: #1A1A2E;
            --text-secondary: #545D7A;
            --gradient-primary: linear-gradient(135deg, #2A6EBB 0%, #1A4F8B 100%);
            --gradient-secondary: linear-gradient(135deg, #00C897 0%, #009C7A 100%);
            --gradient-accent: linear-gradient(135deg, #FF6B6B 0%, #FF4757 100%);
            --shadow-md: 0 8px 24px rgba(42, 110, 187, 0.12);
            --shadow-lg: 0 16px 48px rgba(42, 110, 187, 0.16);
            --shadow-xl: 0 24px 64px rgba(42, 110, 187, 0.2);
            --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="dark"] {
            --bg-primary: #0A0A1A;
            --bg-secondary: #15152B;
            --bg-tertiary: #1E1E3A;
            --text-primary: #FFFFFF;
            --text-secondary: #B0B7D6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(42, 110, 187, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 200, 151, 0.1) 0%, transparent 50%);
        }

        h1, h2, h3 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 700;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* Header */
        .page-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(42, 110, 187, 0.1);
        }

        .header-icon {
            width: 60px;
            height: 60px;
            background: var(--gradient-primary);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.8rem;
        }

        .header-content h1 {
            font-size: 2.5rem;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-content p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        /* Navigation */
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            padding: 12px 24px;
            border-radius: 12px;
            background: var(--bg-tertiary);
            transition: var(--transition);
        }

        .back-button:hover {
            background: var(--primary);
            color: white;
            transform: translateX(-5px);
        }

        .theme-toggle {
            background: var(--bg-tertiary);
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
        }

        .theme-toggle:hover {
            background: var(--primary);
            color: white;
        }

        /* Form Container */
        .form-container {
            background: var(--bg-primary);
            border-radius: 24px;
            padding: 40px;
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(42, 110, 187, 0.1);
            position: relative;
            overflow: hidden;
        }

        .form-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: var(--gradient-primary);
        }

        /* Form Grid */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 30px;
            margin-bottom: 40px;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Form Groups */
        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-label .required {
            color: var(--accent);
            margin-left: 4px;
        }

        .form-label .helper {
            display: block;
            font-weight: 400;
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Input Styles */
        .form-input,
        .form-select {
            width: 100%;
            padding: 16px;
            background: var(--bg-tertiary);
            border: 2px solid transparent;
            border-radius: 12px;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            color: var(--text-primary);
            transition: var(--transition);
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--bg-primary);
            box-shadow: 0 0 0 4px rgba(42, 110, 187, 0.1);
        }

        .form-input::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }

        /* Select Styling */
        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23545D7A' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            padding-right: 48px;
            cursor: pointer;
        }

        .form-select option {
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 12px;
        }

        /* Medicine Select with Preview */
        .medicine-select-container {
            position: relative;
        }

        .medicine-preview {
            display: none;
            background: var(--bg-tertiary);
            padding: 16px;
            border-radius: 12px;
            margin-top: 12px;
            border-left: 4px solid var(--primary);
        }

        .medicine-preview.active {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .preview-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary);
        }

        .preview-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .preview-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Date Input Styling */
        .date-input-container {
            position: relative;
        }

        .date-input-container::after {
            content: '\f073';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            pointer-events: none;
        }

        /* Quantity Input with Units */
        .quantity-input-container {
            position: relative;
        }

        .quantity-unit {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 0.875rem;
            pointer-events: none;
        }

        /* Batch Number Suggestions */
        .batch-suggestions {
            display: flex;
            gap: 10px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .batch-suggestion {
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border-radius: 20px;
            font-size: 0.875rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
        }

        .batch-suggestion:hover {
            background: var(--primary);
            color: white;
        }

        /* Expiry Warning */
        .expiry-warning {
            display: none;
            background: rgba(255, 164, 27, 0.1);
            border: 1px solid rgba(255, 164, 27, 0.2);
            color: var(--warning);
            padding: 12px 16px;
            border-radius: 12px;
            margin-top: 12px;
            font-size: 0.875rem;
        }

        .expiry-warning.active {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Form Actions */
        .form-actions {
            display: flex;
            gap: 20px;
            justify-content: flex-end;
            margin-top: 40px;
            padding-top: 40px;
            border-top: 1px solid rgba(42, 110, 187, 0.1);
        }

        @media (max-width: 480px) {
            .form-actions {
                flex-direction: column;
            }
        }

        /* Buttons */
        .btn {
            padding: 16px 32px;
            border-radius: 12px;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 8px 24px rgba(42, 110, 187, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(42, 110, 187, 0.4);
        }

        .btn-secondary {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-secondary:hover:not(:disabled) {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* Success/Error Messages */
        .message {
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 25px;
            display: none;
            align-items: center;
            gap: 12px;
            animation: slideDown 0.5s ease;
        }

        .message-success {
            background: rgba(0, 200, 151, 0.1);
            color: var(--secondary);
            border: 1px solid rgba(0, 200, 151, 0.2);
        }

        .message-error {
            background: rgba(255, 107, 107, 0.1);
            color: var(--accent);
            border: 1px solid rgba(255, 107, 107, 0.2);
        }

        /* Stats Bar */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-top: 40px;
        }

        @media (max-width: 768px) {
            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .stats-bar {
                grid-template-columns: 1fr;
            }
        }

        .stat-card {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 16px;
            text-align: center;
        }

        .stat-icon {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        /* Footer */
        .form-footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid rgba(42, 110, 187, 0.1);
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Navigation -->
        <div class="nav-buttons">
            <a href="/inventory" class="back-button">
                <i class="fas fa-arrow-left"></i>
                Back to Inventory
            </a>
            <button class="theme-toggle" id="themeToggle">
                <i class="fas fa-moon"></i>
            </button>
        </div>

        <!-- Page Header -->
        <div class="page-header">
            <div class="header-icon">
                <i class="fas fa-boxes"></i>
            </div>
            <div class="header-content">
                <h1>Add New Batch</h1>
                <p>Add a new medicine batch to your pharmacy inventory</p>
            </div>
        </div>

        <!-- Success/Error Messages -->
        <div class="message message-success" id="successMessage">
            <i class="fas fa-check-circle"></i>
            <span>Batch added successfully! Redirecting to inventory...</span>
        </div>

        <div class="message message-error" id="errorMessage">
            <i class="fas fa-exclamation-circle"></i>
            <span id="errorText">Please fill all required fields correctly.</span>
        </div>

        <!-- Form Container -->
        <div class="form-container">
            <form method="post" id="addBatchForm">
                <div class="form-grid">
                    <!-- Medicine Selection -->
                    <div class="form-group">
                        <label class="form-label">
                            Medicine
                            <span class="required">*</span>
                            <span class="helper">Select a medicine from your inventory</span>
                        </label>
                        <div class="medicine-select-container">
                            <select name="medicine_id" class="form-select" required id="medicineSelect">
                                <!-- Medicines will be populated by backend -->
                                {% for m in medicines %}
                                    <option value="{{ m.id }}" data-stock="{{ m.stock }}" data-type="{{ m.type }}" data-unit="{{ m.unit }}">
                                        {{ m.name }}
                                    </option>
                                {% endfor %}
                            </select>
                            <div class="medicine-preview" id="medicinePreview">
                                <div class="preview-title" id="previewName">Medicine Details</div>
                                <div class="preview-details">
                                    <div class="preview-item">
                                        <i class="fas fa-cube"></i>
                                        <span>Type: <span id="previewType">Tablet</span></span>
                                    </div>
                                    <div class="preview-item">
                                        <i class="fas fa-layer-group"></i>
                                        <span>Current Stock: <span id="previewStock">0</span> units</span>
                                    </div>
                                    <div class="preview-item">
                                        <i class="fas fa-weight"></i>
                                        <span>Unit: <span id="previewUnit">Tablet</span></span>
                                    </div>
                                    <div class="preview-item">
                                        <i class="fas fa-history"></i>
                                        <span>Last Added: <span id="previewLastAdded">2 weeks ago</span></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Batch Number -->
                    <div class="form-group">
                        <label class="form-label">
                            Batch Number
                            <span class="required">*</span>
                            <span class="helper">Unique identifier for this batch</span>
                        </label>
                        <input type="text" name="batch_number" class="form-input" placeholder="e.g., BATCH2024-001" required id="batchNumberInput">
                        <div class="batch-suggestions">
                            <div class="batch-suggestion" data-suggestion="BATCH{{ currentYear }}-001">BATCH{{ currentYear }}-001</div>
                            <div class="batch-suggestion" data-suggestion="LOT{{ currentYear }}-A">LOT{{ currentYear }}-A</div>
                            <div class="batch-suggestion" data-suggestion="{{ randomBatch }}">{{ randomBatch }}</div>
                        </div>
                    </div>

                    <!-- Expiry Date -->
                    <div class="form-group">
                        <label class="form-label">
                            Expiry Date
                            <span class="required">*</span>
                            <span class="helper">Use FEFO (First Expired, First Out) principle</span>
                        </label>
                        <div class="date-input-container">
                            <input type="date" name="expiry_date" class="form-input" required id="expiryDateInput" min="{{ today }}">
                        </div>
                        <div class="expiry-warning" id="expiryWarning">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>This batch will expire in less than 6 months</span>
                        </div>
                    </div>

                    <!-- Quantity -->
                    <div class="form-group">
                        <label class="form-label">
                            Quantity
                            <span class="required">*</span>
                            <span class="helper">Number of units in this batch</span>
                        </label>
                        <div class="quantity-input-container">
                            <input type="number" name="quantity" class="form-input" min="1" required placeholder="100" id="quantityInput">
                            <span class="quantity-unit" id="quantityUnit">units</span>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="reset" class="btn btn-secondary" id="resetBtn">
                        <i class="fas fa-redo"></i>
                        Clear Form
                    </button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <i class="fas fa-plus-circle"></i>
                        Add Batch to Inventory
                    </button>
                </div>
            </form>
        </div>

        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-pills"></i>
                </div>
                <div class="stat-value" id="totalMedicines">{{ total_medicines }}</div>
                <div class="stat-label">Total Medicines</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-boxes"></i>
                </div>
                <div class="stat-value" id="activeBatches">{{ active_batches }}</div>
                <div class="stat-label">Active Batches</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-hourglass-end"></i>
                </div>
                <div class="stat-value" id="expiringSoon">{{ expiring_soon }}</div>
                <div class="stat-label">Expiring Soon</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stat-value" id="monthlyAdded">{{ monthly_added }}</div>
                <div class="stat-label">Added This Month</div>
            </div>
        </div>

        <!-- Form Footer -->
        <div class="form-footer">
            <p>
                <i class="fas fa-lightbulb"></i>
                <strong>Tip:</strong> Use consistent batch numbering and regularly check expiry dates to maintain optimal inventory health.
            </p>
        </div>
    </div>

    <script>
        // ===== THEME TOGGLE =====
        const themeToggle = document.getElementById('themeToggle');
        const currentTheme = localStorage.getItem('theme') || 'light';
        
        document.documentElement.setAttribute('data-theme', currentTheme);
        updateThemeIcon(currentTheme);
        
        themeToggle.addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        });
        
        function updateThemeIcon(theme) {
            const icon = themeToggle.querySelector('i');
            icon.className = theme === 'light' ? 'fas fa-moon' : 'fas fa-sun';
        }

        // ===== FORM ELEMENTS =====
        const form = document.getElementById('addBatchForm');
        const medicineSelect = document.getElementById('medicineSelect');
        const medicinePreview = document.getElementById('medicinePreview');
        const batchNumberInput = document.getElementById('batchNumberInput');
        const expiryDateInput = document.getElementById('expiryDateInput');
        const expiryWarning = document.getElementById('expiryWarning');
        const quantityInput = document.getElementById('quantityInput');
        const quantityUnit = document.getElementById('quantityUnit');
        const submitBtn = document.getElementById('submitBtn');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');

        // ===== MEDICINE SELECT PREVIEW =====
        medicineSelect.addEventListener('change', () => {
            const selectedOption = medicineSelect.options[medicineSelect.selectedIndex];
            const medicineName = selectedOption.text;
            const stock = selectedOption.getAttribute('data-stock') || '0';
            const type = selectedOption.getAttribute('data-type') || 'Tablet';
            const unit = selectedOption.getAttribute('data-unit') || 'Tablet';
            
            // Update preview
            document.getElementById('previewName').textContent = medicineName;
            document.getElementById('previewStock').textContent = stock;
            document.getElementById('previewType').textContent = type;
            document.getElementById('previewUnit').textContent = unit;
            
            // Show preview
            medicinePreview.classList.add('active');
            
            // Update quantity unit
            quantityUnit.textContent = unit.toLowerCase() + 's';
            
            // Auto-generate batch number suggestion
            if (!batchNumberInput.value) {
                const year = new Date().getFullYear();
                const randomNum = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                const suggestion = `${type.toUpperCase().slice(0, 3)}${year}${randomNum}`;
                batchNumberInput.value = suggestion;
            }
        });

        // Trigger change on page load
        if (medicineSelect.options.length > 0) {
            medicineSelect.dispatchEvent(new Event('change'));
        }

        // ===== BATCH NUMBER SUGGESTIONS =====
        document.querySelectorAll('.batch-suggestion').forEach(suggestion => {
            suggestion.addEventListener('click', () => {
                batchNumberInput.value = suggestion.getAttribute('data-suggestion');
                batchNumberInput.focus();
                
                // Add visual feedback
                suggestion.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    suggestion.style.transform = 'scale(1)';
                }, 200);
            });
        });

        // ===== EXPIRY DATE VALIDATION =====
        function checkExpiryDate() {
            const selectedDate = new Date(expiryDateInput.value);
            const today = new Date();
            const sixMonthsFromNow = new Date();
            sixMonthsFromNow.setMonth(sixMonthsFromNow.getMonth() + 6);
            
            if (selectedDate < sixMonthsFromNow) {
                expiryWarning.classList.add('active');
            } else {
                expiryWarning.classList.remove('active');
            }
            
            // Disable past dates
            const todayString = today.toISOString().split('T')[0];
            expiryDateInput.min = todayString;
        }

        expiryDateInput.addEventListener('change', checkExpiryDate);
        checkExpiryDate(); // Initial check

        // ===== QUANTITY VALIDATION =====
        quantityInput.addEventListener('input', () => {
            const value = parseInt(quantityInput.value) || 0;
            
            if (value > 1000) {
                quantityInput.style.borderColor = 'var(--warning)';
                quantityInput.style.boxShadow = '0 0 0 4px rgba(255, 164, 27, 0.1)';
            } else if (value > 0) {
                quantityInput.style.borderColor = '';
                quantityInput.style.boxShadow = '';
            }
        });

        // ===== FORM SUBMISSION =====
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            
            // Hide previous messages
            successMessage.style.display = 'none';
            errorMessage.style.display = 'none';
            
            // Validate form
            const errors = [];
            
            if (!medicineSelect.value) {
                errors.push('Please select a medicine');
                medicineSelect.style.borderColor = 'var(--accent)';
            } else {
                medicineSelect.style.borderColor = '';
            }
            
            if (!batchNumberInput.value.trim()) {
                errors.push('Please enter a batch number');
                batchNumberInput.style.borderColor = 'var(--accent)';
            } else {
                batchNumberInput.style.borderColor = '';
            }
            
            if (!expiryDateInput.value) {
                errors.push('Please select an expiry date');
                expiryDateInput.style.borderColor = 'var(--accent)';
            } else {
                expiryDateInput.style.borderColor = '';
            }
            
            const quantity = parseInt(quantityInput.value);
            if (!quantity || quantity < 1) {
                errors.push('Please enter a valid quantity (minimum 1)');
                quantityInput.style.borderColor = 'var(--accent)';
            } else {
                quantityInput.style.borderColor = '';
            }
            
            // Check for duplicate batch numbers (simulated)
            const existingBatchNumbers = ['BATCH2024-001', 'BATCH2024-002', 'LOT2024-A'];
            if (existingBatchNumbers.includes(batchNumberInput.value.trim().toUpperCase())) {
                errors.push('This batch number already exists');
                batchNumberInput.style.borderColor = 'var(--accent)';
            }
            
            if (errors.length > 0) {
                errorText.textContent = errors.join('. ');
                errorMessage.style.display = 'flex';
                errorMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
                return;
            }
            
            // Show loading state
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding Batch...';
            submitBtn.disabled = true;
            
            // Simulate API call
            setTimeout(() => {
                // Success simulation
                successMessage.style.display = 'flex';
                submitBtn.innerHTML = '<i class="fas fa-check"></i> Batch Added!';
                
                // Update stats (simulated)
                updateStats();
                
                // Redirect after delay
                setTimeout(() => {
                    // In production, this would submit the form
                    form.submit();
                }, 2000);
                
            }, 1500);
        });

        // ===== RESET BUTTON =====
        document.getElementById('resetBtn').addEventListener('click', (e) => {
            e.preventDefault();
            
            if (confirm('Are you sure you want to clear all form data?')) {
                form.reset();
                medicinePreview.classList.remove('active');
                expiryWarning.classList.remove('active');
                
                // Reset styles
                [medicineSelect, batchNumberInput, expiryDateInput, quantityInput].forEach(input => {
                    input.style.borderColor = '';
                    input.style.boxShadow = '';
                });
                
                // Show success message
                const resetMessage = document.createElement('div');
                resetMessage.className = 'message message-success';
                resetMessage.innerHTML = '<i class="fas fa-redo"></i> Form cleared successfully';
                resetMessage.style.display = 'flex';
                
                form.insertBefore(resetMessage, form.firstChild);
                
                setTimeout(() => {
                    resetMessage.style.display = 'none';
                }, 3000);
            }
        });

        // ===== STATS UPDATE =====
        function updateStats() {
            // Simulate stats update
            const stats = ['totalMedicines', 'activeBatches', 'expiringSoon', 'monthlyAdded'];
            
            stats.forEach(statId => {
                const element = document.getElementById(statId);
                if (element) {
                    const current = parseInt(element.textContent) || 0;
                    let newValue = current;
                    
                    if (statId === 'totalMedicines') {
                        // Check if we're adding a new medicine
                        const selectedMedicine = medicineSelect.options[medicineSelect.selectedIndex];
                        const medicineName = selectedMedicine.text.toLowerCase();
                        const existingMedicines = ['paracetamol', 'amoxicillin', 'ibuprofen'];
                        if (!existingMedicines.some(m => medicineName.includes(m))) {
                            newValue = current + 1;
                        }
                    } else if (statId === 'activeBatches') {
                        newValue = current + 1;
                    } else if (statId === 'monthlyAdded') {
                        newValue = current + 1;
                    }
                    
                    // Animate number change
                    animateCounter(element, current, newValue);
                }
            });
        }

        function animateCounter(element, start, end) {
            let current = start;
            const increment = end > start ? 1 : -1;
            const timer = setInterval(() => {
                current += increment;
                element.textContent = current;
                
                if (current === end) {
                    clearInterval(timer);
                    
                    // Add celebration effect
                    element.style.transform = 'scale(1.2)';
                    element.style.color = 'var(--success)';
                    
                    setTimeout(() => {
                        element.style.transform = 'scale(1)';
                        element.style.color = '';
                    }, 500);
                }
            }, 50);
        }

        // ===== KEYBOARD SHORTCUTS =====
        document.addEventListener('keydown', (e) => {
            // Ctrl+Enter to submit
            if (e.ctrlKey && e.key === 'Enter') {
                e.preventDefault();
                form.requestSubmit();
            }
            
            // Ctrl+Shift+R to reset
            if (e.ctrlKey && e.shiftKey && e.key === 'R') {
                e.preventDefault();
                document.getElementById('resetBtn').click();
            }
            
            // Escape to focus medicine select
            if (e.key === 'Escape') {
                e.preventDefault();
                medicineSelect.focus();
            }
        });

        // ===== AUTO-GENERATE SUGGESTIONS =====
        // Set current year for batch suggestions
        const currentYear = new Date().getFullYear();
        document.querySelectorAll('[data-suggestion]').forEach(el => {
            const suggestion = el.getAttribute('data-suggestion')
                .replace('{{ currentYear }}', currentYear)
                .replace('{{ randomBatch }}', `BATCH${currentYear}-${Math.floor(Math.random() * 1000).toString().padStart(3, '0')}`);
            el.setAttribute('data-suggestion', suggestion);
            el.textContent = suggestion;
        });

        // Set today as minimum date
        const today = new Date().toISOString().split('T')[0];
        expiryDateInput.min = today;

        // ===== FORM AUTO-SAVE (simulated) =====
        let autoSaveTimeout;
        function autoSaveForm() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                const formData = new FormData(form);
                const data = {};
                for (let [key, value] of formData.entries()) {
                    data[key] = value;
                }
                
                // Simulate auto-save
                console.log('Auto-saving form data:', data);
                
                // Show auto-save indicator
                const indicator = document.createElement('div');
                indicator.className = 'message message-success';
                indicator.style.position = 'fixed';
                indicator.style.bottom = '20px';
                indicator.style.right = '20px';
                indicator.style.width = 'auto';
                indicator.innerHTML = '<i class="fas fa-save"></i> Draft saved';
                indicator.style.display = 'flex';
                
                document.body.appendChild(indicator);
                
                setTimeout(() => {
                    indicator.style.opacity = '0';
                    setTimeout(() => indicator.remove(), 300);
                }, 2000);
                
            }, 2000); // Save after 2 seconds of inactivity
        }

        // Add auto-save listeners
        [medicineSelect, batchNumberInput, expiryDateInput, quantityInput].forEach(input => {
            input.addEventListener('input', autoSaveForm);
            input.addEventListener('change', autoSaveForm);
        });

        // Load saved draft on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Simulate loading saved draft
            const savedDraft = localStorage.getItem('batchFormDraft');
            if (savedDraft) {
                try {
                    const draft = JSON.parse(savedDraft);
                    // Apply saved data (in production, this would populate the form)
                } catch (e) {
                    console.log('No saved draft found');
                }
            }
        });

        // Save draft before unload
        window.addEventListener('beforeunload', (e) => {
            const formData = new FormData(form);
            const data = {};
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            if (Object.keys(data).length > 0) {
                localStorage.setItem('batchFormDraft', JSON.stringify(data));
            }
        });
    </script>
</body>
</html>